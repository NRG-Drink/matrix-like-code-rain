using NRG.Matrix.Build.Modules.Common;
using ModularPipelines.Attributes;
using ModularPipelines.Configuration;
using ModularPipelines.Context;
using ModularPipelines.Models;
using ModularPipelines.Modules;

namespace NRG.Matrix.Build.Modules.Testing;

[RunOnLocalMachineOnly]
[RunOnWindows]
[DependsOn<FindRepoPaths>]
[DependsOn<GenerateTestReport>(Optional = true)]
[NotInParallel(nameof(OpenTestReport))]
public class OpenTestReport : Module<CommandResult>
{
    protected override ModuleConfiguration Configure()
        => ModuleConfiguration.Create()
            .WithIgnoreFailures()
            .Build();

    protected override async Task<CommandResult?> ExecuteAsync(IModuleContext context, CancellationToken cancellationToken)
    {
        var repoPaths = await context.GetModule<FindRepoPaths>();
        var result = await context.Shell.PowerShell.Script(new($"start") { Arguments = [repoPaths.ValueOrDefault!.TestReportHtml.Path] }, cancellationToken);
        return result;
    }
}
